<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สรุปการเงินส่วนตัว</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans Thai', sans-serif; }
        .card { transition: transform 0.2s, box-shadow 0.2s; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .progress-bar { transition: width 0.8s ease-in-out; }
        .section-title { position: relative; padding-left: 16px; }
        .section-title::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; border-radius: 2px; }
        .section-income::before { background: #10b981; }
        .section-expense::before { background: #ef4444; }
        .section-debt::before { background: #f59e0b; }
        .section-people::before { background: #8b5cf6; }
        .section-analysis::before { background: #3b82f6; }
        .fade-in { animation: fadeIn 0.6s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Header -->
    <header class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white py-8 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6">
            <h1 class="text-3xl sm:text-4xl font-bold">สรุปการเงินส่วนตัว</h1>
            <p class="mt-2 text-indigo-200">งบรายรับรายจ่าย เม.ย. - ธ.ค. 2569 (พ.ศ.)</p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8 space-y-10">

        <!-- Section 1: Summary Cards -->
        <section class="fade-in">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="card bg-white rounded-xl shadow p-6 border-l-4 border-green-500">
                    <p class="text-sm text-gray-500">รายรับเฉลี่ยต่อเดือน</p>
                    <p class="text-2xl font-bold text-green-600 mt-1">฿45,983</p>
                    <p class="text-xs text-gray-400 mt-1">เงินเดือน + รายได้เสริม</p>
                </div>
                <div class="card bg-white rounded-xl shadow p-6 border-l-4 border-red-500">
                    <p class="text-sm text-gray-500">รายจ่ายประจำ/เดือน</p>
                    <p class="text-2xl font-bold text-red-600 mt-1">฿24,600 ~ 26,100</p>
                    <p class="text-xs text-gray-400 mt-1">ผ่อนบ้าน + ค่าใช้จ่ายคงที่</p>
                </div>
                <div class="card bg-white rounded-xl shadow p-6 border-l-4 border-amber-500">
                    <p class="text-sm text-gray-500">หนี้คงค้างรวม</p>
                    <p class="text-2xl font-bold text-amber-600 mt-1">฿139,319</p>
                    <p class="text-xs text-gray-400 mt-1">KTC + UOB + Shopee</p>
                </div>
                <div class="card bg-white rounded-xl shadow p-6 border-l-4 border-blue-500">
                    <p class="text-sm text-gray-500">คนที่เป็นหนี้เรา</p>
                    <p class="text-2xl font-bold text-blue-600 mt-1">฿4,800</p>
                    <p class="text-xs text-gray-400 mt-1">โดนัท (เบิร์น+ปอนจ่ายครบ)</p>
                </div>
            </div>
        </section>

        <!-- Section 2: Monthly Budget -->
        <section class="fade-in">
            <h2 class="text-2xl font-bold mb-4 section-title section-income">งบรายรับรายจ่ายรายเดือน (เม.ย. - ธ.ค. 69)</h2>
            <div class="flex gap-2 mb-3">
                <button id="tabBefore" onclick="switchBudgetTab('before')" class="px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white shadow">ปัจจุบัน</button>
                <button id="tabAfter" onclick="switchBudgetTab('after')" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-200 text-gray-600 hover:bg-gray-300">หลังปิดหนี้ ฿35,000</button>
            </div>
            <div class="bg-white rounded-xl shadow overflow-x-auto">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600">
                            <th class="py-3 px-4 text-left">รายการ</th>
                            <th class="py-3 px-3 text-right">เม.ย.</th>
                            <th class="py-3 px-3 text-right">พ.ค.</th>
                            <th class="py-3 px-3 text-right">มิ.ย.</th>
                            <th class="py-3 px-3 text-right">ก.ค.</th>
                            <th class="py-3 px-3 text-right">ส.ค.</th>
                            <th class="py-3 px-3 text-right">ก.ย.</th>
                            <th class="py-3 px-3 text-right">ต.ค.</th>
                            <th class="py-3 px-3 text-right">พ.ย.</th>
                            <th class="py-3 px-3 text-right">ธ.ค.</th>
                        </tr>
                    </thead>
                    <tbody id="budgetTable"></tbody>
                </table>
            </div>
            <div class="mt-6 bg-white rounded-xl shadow p-6">
                <canvas id="budgetChart" height="100"></canvas>
            </div>
        </section>

        <!-- Section 3: Debt Overview -->
        <section class="fade-in">
            <h2 class="text-2xl font-bold mb-4 section-title section-debt">หนี้สินคงค้าง</h2>

            <!-- Closed debts banner -->
            <div class="mb-4 bg-green-50 border border-green-200 rounded-xl p-4 flex items-center gap-3">
                <span class="text-2xl">&#10003;</span>
                <div>
                    <p class="font-semibold text-green-800">ปิดครบแล้ว</p>
                    <p class="text-sm text-green-600">KBANK ทุกรายการ (฿10,839.34) + หนี้รวมเดิม 144,500 บาท (ญี่ปุ่น+รถ+โซฟา+แอร์) - ปิดเมื่อ 05/02/2026</p>
                </div>
            </div>

            <!-- KTC -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
                    <span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-sm">KTC</span>
                    <span class="text-gray-500 text-sm">คงเหลือ ฿68,470.87</span>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="ktcCards"></div>
            </div>

            <!-- UOB -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
                    <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm">UOB</span>
                    <span class="text-gray-500 text-sm">คงเหลือ ฿36,895.00</span>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="uobCards"></div>
            </div>

            <!-- Shopee -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
                    <span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-sm">Shopee PayLater</span>
                    <span class="text-gray-500 text-sm">คงเหลือ ฿33,953.12</span>
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="shopeeCards"></div>
            </div>
        </section>

        <!-- Section 4: People who owe us -->
        <section class="fade-in">
            <h2 class="text-2xl font-bold mb-4 section-title section-people">คนที่เป็นหนี้เรา</h2>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="card bg-white rounded-xl shadow p-5">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-lg">โดนัท</p>
                            <p class="text-sm text-gray-500">TV</p>
                        </div>
                        <span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded-full">ค้างอยู่</span>
                    </div>
                    <p class="text-xl font-bold mt-3">฿4,800 <span class="text-sm font-normal text-gray-400">/ ฿9,600</span></p>
                    <p class="text-xs text-gray-400 mt-1">จ่ายงวดละ ฿9,600 | อัพเดต 23/02/2026</p>
                    <div class="mt-3 bg-gray-200 rounded-full h-2">
                        <div class="bg-yellow-500 h-2 rounded-full progress-bar" style="width: 50%"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 text-right">50%</p>
                </div>
                <div class="card bg-white rounded-xl shadow p-5">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-lg">เบิร์น</p>
                            <p class="text-sm text-gray-500">iPhone 17 PM</p>
                        </div>
                        <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full">จ่ายครบ</span>
                    </div>
                    <p class="text-xl font-bold mt-3">฿32,500 <span class="text-sm font-normal text-gray-400">/ ฿32,500</span></p>
                    <p class="text-xs text-gray-400 mt-1">งวดละ ฿3,250 | อัพเดต 28/02/2026</p>
                    <div class="mt-3 bg-gray-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full progress-bar" style="width: 100%"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 text-right">100%</p>
                </div>
                <div class="card bg-white rounded-xl shadow p-5">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-semibold text-lg">ปอน</p>
                            <p class="text-sm text-gray-500">iPad mini 6</p>
                        </div>
                        <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full">จ่ายครบ</span>
                    </div>
                    <p class="text-xl font-bold mt-3">฿17,900 <span class="text-sm font-normal text-gray-400">/ ฿17,900</span></p>
                    <p class="text-xs text-gray-400 mt-1">จ่ายครบแล้ว | อัพเดต 28/02/2026</p>
                    <div class="mt-3 bg-gray-200 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full progress-bar" style="width: 100%"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1 text-right">100%</p>
                </div>
            </div>
        </section>

        <!-- Section 5: Debt Payoff Analysis with 30,000 -->
        <section class="fade-in">
            <h2 class="text-2xl font-bold mb-4 section-title section-analysis">วิเคราะห์ปิดหนี้ด้วยเงิน ฿35,000</h2>
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-4">
                <p class="text-sm text-blue-800"><strong>สถานการณ์:</strong> มีเงินก้อน ฿35,000 ต้องการใช้ปิดหนี้ให้คุ้มค่าที่สุด เพื่อลดภาระรายจ่ายรายเดือน</p>
                <p class="text-sm text-blue-700 mt-1"><strong>หมายเหตุ:</strong> ไม่นับรายได้จากเบิร์นแล้ว (จ่ายครบ) รายรับหลัก ฿44,900/เดือน + รายได้อื่น (ปอน/โดนัท)</p>
            </div>

            <h3 class="text-lg font-semibold mb-3">Option A: ปิดรายการเล็กก่อน (Snowball)</h3>
            <div class="bg-white rounded-xl shadow overflow-x-auto mb-4">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-indigo-50 text-gray-600">
                            <th class="py-3 px-4 text-left">รายการที่ควรปิด</th>
                            <th class="py-3 px-4 text-right">ยอดคงเหลือ</th>
                            <th class="py-3 px-4 text-right">ค่างวด/เดือน</th>
                            <th class="py-3 px-4 text-center">จำนวนงวดคงเหลือ</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b">
                            <td class="py-3 px-4 font-medium">1. KTC MI PAD</td>
                            <td class="py-3 px-4 text-right">฿2,399.70</td>
                            <td class="py-3 px-4 text-right">฿799.90</td>
                            <td class="py-3 px-4 text-center">3 งวด</td>
                        </tr>
                        <tr class="border-b">
                            <td class="py-3 px-4 font-medium">2. UOB รองเท้า Asics</td>
                            <td class="py-3 px-4 text-right">฿2,565.00</td>
                            <td class="py-3 px-4 text-right">฿428.00</td>
                            <td class="py-3 px-4 text-center">6 งวด</td>
                        </tr>
                        <tr class="border-b">
                            <td class="py-3 px-4 font-medium">3. UOB iPad Mini</td>
                            <td class="py-3 px-4 text-right">฿2,980.00</td>
                            <td class="py-3 px-4 text-right">฿1,490.00</td>
                            <td class="py-3 px-4 text-center">2 งวด</td>
                        </tr>
                        <tr class="border-b">
                            <td class="py-3 px-4 font-medium">4. KTC กินเบียร์เลี้ยงรุ่น</td>
                            <td class="py-3 px-4 text-right">฿4,365.76</td>
                            <td class="py-3 px-4 text-right">฿623.68</td>
                            <td class="py-3 px-4 text-center">7 งวด</td>
                        </tr>
                        <tr class="border-b">
                            <td class="py-3 px-4 font-medium">5. KTC AIA (รอบ 2)</td>
                            <td class="py-3 px-4 text-right">฿6,605.10</td>
                            <td class="py-3 px-4 text-right">฿1,321.02</td>
                            <td class="py-3 px-4 text-center">5 งวด</td>
                        </tr>
                        <tr class="border-b">
                            <td class="py-3 px-4 font-medium">6. KTC แว่นใหม่</td>
                            <td class="py-3 px-4 text-right">฿12,300.00</td>
                            <td class="py-3 px-4 text-right">฿3,075.00</td>
                            <td class="py-3 px-4 text-center">4 งวด</td>
                        </tr>
                        <tr class="bg-green-50 font-semibold">
                            <td class="py-3 px-4">รวมใช้ปิดหนี้</td>
                            <td class="py-3 px-4 text-right">฿31,215.56</td>
                            <td class="py-3 px-4 text-right text-green-600">ประหยัด ฿7,737.60/เดือน</td>
                            <td class="py-3 px-4"></td>
                        </tr>
                        <tr class="bg-blue-50">
                            <td class="py-3 px-4 font-medium text-blue-700">เงินเหลือเก็บ</td>
                            <td class="py-3 px-4 text-right text-blue-700 font-semibold">฿3,784.44</td>
                            <td class="py-3 px-4 text-right text-xs text-gray-400">จาก ฿35,000</td>
                            <td class="py-3 px-4"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="bg-white rounded-xl shadow p-6">
                <h3 class="text-lg font-semibold mb-3">เปรียบเทียบเงินคงเหลือ: ก่อน vs หลังปิดหนี้ ฿35,000 (เม.ย. - ธ.ค. 69)</h3>
                <canvas id="payoffChart" height="100"></canvas>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 text-center py-6 mt-10">
        <p class="text-sm">สรุปการเงินส่วนตัว | ข้อมูลจาก Google Sheets "รายจ่ายรับ_สำรอง"</p>
    </footer>

    <script>
    // ===== DATA =====
    const months = ['เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];

    const budget = {
        income: [
            { name: 'เงินเดือน + เสริม', values: [44900, 44900, 44900, 44900, 44900, 44900, 44900, 44900, 44900] },
            { name: 'รายได้อื่น (โดนัท)', values: [1300, 1300, 1300, 1300, 1300, 0, 0, 0, 0] }
        ],
        fixedExpense: [
            { name: 'ให้แม่', values: [2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000, 2000] },
            { name: 'ค่ากิน (โอนโดนัท)', values: [3000, 3000, 3000, 3000, 3000, 3000, 3000, 3000, 3000] },
            { name: 'ค่าน้ำมัน (โอนโดนัท)', values: [1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000, 1000] },
            { name: 'ค่าผ่อนบ้าน', values: [12000, 12000, 12000, 13500, 13500, 13500, 13500, 13500, 13500] },
            { name: 'ค่าเหมียว-โยดา-โยจิ', values: [2500, 2500, 2500, 2500, 2500, 2500, 2500, 2500, 2500] },
            { name: 'ค่ากิน', values: [3000, 3000, 3000, 3000, 3000, 3000, 3000, 3000, 3000] },
            { name: 'Coway', values: [600, 600, 600, 600, 600, 600, 600, 600, 600] },
            { name: 'ค่าเน็ต', values: [500, 500, 500, 500, 500, 500, 500, 500, 500] }
        ],
        variableExpense: [
            { name: 'บัตร Kplus ทั่วไป', values: [1500, 1500, 1500, 1500, 1500, 1500, 1500, 1500, 1500] },
            { name: 'Shopee', values: [8712, 6967, 4934, 3724, 2908, 2899, 940, 940, 990] },
            { name: 'บัตร KTC', values: [14380, 14380, 14380, 14380, 11305, 624, 0, 0, 0] },
            { name: 'บัตร UOB', values: [6857, 6857, 5367, 5367, 5367, 4297, 0, 0, 0] }
        ],
        remaining: [-9850, -8104, -4581, -4871, -981, 9480, 16360, 16360, 16310]
    };

    // KTC installments
    const ktcPlans = [
        { name: 'MI PAD', total: 7999, perMonth: 799.90, installments: 10, paid: 7, remaining: 2399.70 },
        { name: 'AIA (รอบ 2)', total: 13210.20, perMonth: 1321.02, installments: 10, paid: 5, remaining: 6605.10 },
        { name: 'แม่ผ่าตัด', total: 37700.62, perMonth: 3770.06, installments: 10, paid: 5, remaining: 18850.31 },
        { name: 'มือถือ', total: 47900, perMonth: 4790.00, installments: 10, paid: 5, remaining: 23950.00 },
        { name: 'กินเบียร์เลี้ยงรุ่น', total: 6800, perMonth: 623.68, installments: 10, paid: 3, remaining: 4365.76 },
        { name: 'แว่นใหม่', total: 12300, perMonth: 3075, installments: 4, paid: 0, remaining: 12300 }
    ];

    const uobPlans = [
        { name: 'iPad Mini', total: 14900, perMonth: 1490, installments: 10, paid: 8, remaining: 2980 },
        { name: 'โดนัทฝากจ่าย', total: 27051, perMonth: 2780, installments: 10, paid: 3, remaining: 19460 },
        { name: 'DJI Nano', total: 10700, perMonth: 1070, installments: 10, paid: 5, remaining: 5350 },
        { name: 'รองเท้า Asics', total: 4275, perMonth: 428, installments: 10, paid: 4, remaining: 2565 },
        { name: 'โยจิ รพ.ทองหล่อ', total: 10899.61, perMonth: 1090, installments: 10, paid: 4, remaining: 6540 }
    ];

    const shopeePlans = [
        { name: 'Shopee PayLater (ยอดรวมคงเหลือ)', total: 80608.53, perMonth: null, installments: null, paid: null, remaining: 33953.12, note: 'ยอดรายเดือนไม่คงที่ จ่ายตามงวด' }
    ];

    // ===== AFTER PAYOFF BUDGET =====
    // KTC savings per month: MI PAD, AIA2, กินเบียร์, แว่นใหม่
    const ktcSavings = [5819.60, 5819.60, 5019.70, 5019.70, 623.68, 623.68, 0, 0, 0];
    // UOB savings per month: iPad Mini, Asics
    const uobSavings = [1918, 428, 428, 428, 428, 0, 0, 0, 0];
    const monthlySavings = ktcSavings.map((v, i) => v + uobSavings[i]);

    const budgetAfter = {
        income: budget.income,
        fixedExpense: budget.fixedExpense,
        variableExpense: [
            budget.variableExpense[0], // Kplus
            budget.variableExpense[1], // Shopee
            { name: 'บัตร KTC', values: budget.variableExpense[2].values.map((v, i) => Math.round(Math.max(0, v - ktcSavings[i]))) },
            { name: 'บัตร UOB', values: budget.variableExpense[3].values.map((v, i) => Math.round(Math.max(0, v - uobSavings[i]))) }
        ],
        remaining: budget.remaining.map((v, i) => Math.round(v + monthlySavings[i]))
    };

    let currentTab = 'before';

    function switchBudgetTab(tab) {
        currentTab = tab;
        document.getElementById('tabBefore').className = tab === 'before'
            ? 'px-4 py-2 rounded-lg text-sm font-medium bg-indigo-600 text-white shadow'
            : 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-200 text-gray-600 hover:bg-gray-300';
        document.getElementById('tabAfter').className = tab === 'after'
            ? 'px-4 py-2 rounded-lg text-sm font-medium bg-green-600 text-white shadow'
            : 'px-4 py-2 rounded-lg text-sm font-medium bg-gray-200 text-gray-600 hover:bg-gray-300';
        const data = tab === 'after' ? budgetAfter : budget;
        renderBudgetTable(data);
        renderBudgetChart(data);
    }

    // ===== RENDER BUDGET TABLE =====
    function renderBudgetTable(data) {
        if (!data) data = budget;
        const tbody = document.getElementById('budgetTable');
        let html = '';

        // Income header
        html += `<tr class="bg-green-50"><td colspan="10" class="py-2 px-4 font-semibold text-green-700">รายรับ</td></tr>`;
        data.income.forEach(item => {
            html += `<tr class="border-b border-gray-100"><td class="py-2 px-4 text-gray-600">${item.name}</td>`;
            item.values.forEach(v => { html += `<td class="py-2 px-3 text-right">${formatNum(v)}</td>`; });
            html += `</tr>`;
        });
        const incTotals = months.map((_, i) => data.income.reduce((s, item) => s + item.values[i], 0));
        html += `<tr class="bg-green-100 font-semibold"><td class="py-2 px-4 text-green-700">รวมรายรับ</td>`;
        incTotals.forEach(v => { html += `<td class="py-2 px-3 text-right text-green-700">${formatNum(v)}</td>`; });
        html += `</tr>`;

        // Fixed expense
        html += `<tr class="bg-red-50"><td colspan="10" class="py-2 px-4 font-semibold text-red-700">รายจ่ายประจำ</td></tr>`;
        data.fixedExpense.forEach(item => {
            html += `<tr class="border-b border-gray-100"><td class="py-2 px-4 text-gray-600">${item.name}</td>`;
            item.values.forEach(v => { html += `<td class="py-2 px-3 text-right">${formatNum(v)}</td>`; });
            html += `</tr>`;
        });
        const fixTotals = months.map((_, i) => data.fixedExpense.reduce((s, item) => s + item.values[i], 0));
        html += `<tr class="bg-red-100 font-semibold"><td class="py-2 px-4 text-red-700">รวมรายจ่ายประจำ</td>`;
        fixTotals.forEach(v => { html += `<td class="py-2 px-3 text-right text-red-700">${formatNum(v)}</td>`; });
        html += `</tr>`;

        // Variable expense
        html += `<tr class="bg-orange-50"><td colspan="10" class="py-2 px-4 font-semibold text-orange-700">รายจ่ายผันแปร</td></tr>`;
        data.variableExpense.forEach(item => {
            html += `<tr class="border-b border-gray-100"><td class="py-2 px-4 text-gray-600">${item.name}</td>`;
            item.values.forEach(v => { html += `<td class="py-2 px-3 text-right">${formatNum(v)}</td>`; });
            html += `</tr>`;
        });
        const varTotals = months.map((_, i) => data.variableExpense.reduce((s, item) => s + item.values[i], 0));
        html += `<tr class="bg-orange-100 font-semibold"><td class="py-2 px-4 text-orange-700">รวมรายจ่ายผันแปร</td>`;
        varTotals.forEach(v => { html += `<td class="py-2 px-3 text-right text-orange-700">${formatNum(v)}</td>`; });
        html += `</tr>`;

        // Remaining
        html += `<tr class="bg-gray-800 text-white font-bold"><td class="py-3 px-4">เงินคงเหลือ</td>`;
        data.remaining.forEach(v => {
            const color = v >= 0 ? 'text-green-300' : 'text-red-300';
            html += `<td class="py-3 px-3 text-right ${color}">${formatNum(v)}</td>`;
        });
        html += `</tr>`;

        tbody.innerHTML = html;
    }

    // ===== RENDER DEBT CARDS =====
    function renderDebtCards(plans, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = plans.map(p => {
            const pct = p.paid !== null ? Math.round((p.paid / p.installments) * 100) : null;
            const pctWidth = pct !== null ? pct : Math.round(((p.total - p.remaining) / p.total) * 100);
            const barColor = pctWidth >= 100 ? 'bg-green-500' : pctWidth >= 50 ? 'bg-yellow-500' : 'bg-red-400';
            return `
                <div class="bg-white rounded-lg shadow p-4 border border-gray-100">
                    <div class="flex justify-between items-start">
                        <p class="font-medium">${p.name}</p>
                        <span class="text-xs ${p.remaining === 0 ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'} px-2 py-0.5 rounded-full">
                            ${p.remaining === 0 ? 'ปิดแล้ว' : 'คงเหลือ ฿' + formatNum(p.remaining)}
                        </span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">ยอดรวม ฿${formatNum(p.total)} ${p.perMonth ? '| งวดละ ฿' + formatNum(p.perMonth) : ''}</p>
                    ${p.note ? `<p class="text-xs text-gray-400 mt-1">${p.note}</p>` : ''}
                    <div class="mt-2 bg-gray-200 rounded-full h-2">
                        <div class="${barColor} h-2 rounded-full progress-bar" style="width: ${pctWidth}%"></div>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 text-right">${p.paid !== null ? p.paid + '/' + p.installments + ' งวด' : ''} (${pctWidth}%)</p>
                </div>
            `;
        }).join('');
    }

    // ===== CHARTS =====
    let budgetChartInstance = null;

    function renderBudgetChart(data) {
        if (!data) data = budget;
        if (budgetChartInstance) budgetChartInstance.destroy();

        const incTotals = months.map((_, i) => data.income.reduce((s, item) => s + item.values[i], 0));
        const expTotals = months.map((_, i) => {
            const fix = data.fixedExpense.reduce((s, item) => s + item.values[i], 0);
            const vari = data.variableExpense.reduce((s, item) => s + item.values[i], 0);
            return fix + vari;
        });

        budgetChartInstance = new Chart(document.getElementById('budgetChart'), {
            type: 'bar',
            data: {
                labels: months,
                datasets: [
                    { label: 'รายรับ', data: incTotals, backgroundColor: 'rgba(16, 185, 129, 0.7)', borderColor: '#10b981', borderWidth: 1 },
                    { label: 'รายจ่ายรวม', data: expTotals, backgroundColor: 'rgba(239, 68, 68, 0.7)', borderColor: '#ef4444', borderWidth: 1 },
                    { label: 'เงินคงเหลือ', data: data.remaining, backgroundColor: data.remaining.map(v => v >= 0 ? 'rgba(59, 130, 246, 0.7)' : 'rgba(249, 115, 22, 0.7)'), borderColor: data.remaining.map(v => v >= 0 ? '#3b82f6' : '#f97316'), borderWidth: 1, type: 'line', fill: false, tension: 0.3 }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ฿' + formatNum(ctx.raw) } }
                },
                scales: {
                    y: { ticks: { callback: v => '฿' + formatNum(v) } }
                }
            }
        });
    }

    function renderPayoffChart() {
        const chartMonths = ['เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
        const beforeRemaining = budget.remaining;

        // Monthly savings from closing 6 debts early (varies by month as debts naturally end)
        // เม.ย.: MI PAD+iPad Mini+Asics+กินเบียร์+AIA2+แว่น = 7737.60
        // พ.ค.: MI PAD+Asics+กินเบียร์+AIA2+แว่น = 6247.60 (iPad Mini จบ)
        // มิ.ย.: Asics+กินเบียร์+AIA2+แว่น = 5447.70 (MI PAD จบ)
        // ก.ค.: Asics+กินเบียร์+AIA2+แว่น = 5447.70
        // ส.ค.: Asics+กินเบียร์ = 1051.68 (AIA2+แว่น จบ)
        // ก.ย.: กินเบียร์ = 623.68 (Asics จบ)
        // ต.ค.-ธ.ค.: 0 (หนี้หมดตามธรรมชาติ)
        const monthlySavings = [7737.60, 6247.60, 5447.70, 5447.70, 1051.68, 623.68, 0, 0, 0];
        const afterRemaining = beforeRemaining.map((v, i) => v + monthlySavings[i]);

        new Chart(document.getElementById('payoffChart'), {
            type: 'bar',
            data: {
                labels: chartMonths,
                datasets: [
                    { label: 'ก่อนปิดหนี้', data: beforeRemaining, backgroundColor: 'rgba(239, 68, 68, 0.6)', borderColor: '#ef4444', borderWidth: 1 },
                    { label: 'หลังปิดหนี้ (ใช้ ฿35,000)', data: afterRemaining, backgroundColor: 'rgba(16, 185, 129, 0.6)', borderColor: '#10b981', borderWidth: 1 }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: { callbacks: { label: ctx => ctx.dataset.label + ': ฿' + formatNum(ctx.raw) } }
                },
                scales: {
                    y: {
                        ticks: { callback: v => '฿' + formatNum(v) },
                        title: { display: true, text: 'เงินคงเหลือ (บาท)' }
                    }
                }
            }
        });
    }

    // ===== UTILITIES =====
    function formatNum(n) {
        if (n === null || n === undefined) return '-';
        const neg = n < 0;
        const abs = Math.abs(n);
        const formatted = abs.toLocaleString('th-TH', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
        return neg ? '-' + formatted : formatted;
    }

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', () => {
        renderBudgetTable();
        renderDebtCards(ktcPlans, 'ktcCards');
        renderDebtCards(uobPlans, 'uobCards');
        renderDebtCards(shopeePlans, 'shopeeCards');
        renderBudgetChart();
        renderPayoffChart();
    });
    </script>
</body>
</html>
